<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arctic Marine Vessel Tracker</title>
  
  <!-- Mapbox GL JS CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="index.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
  <div id="app">
    <nav>
      <h2>  Arctic Marine Vessel Tracker  </h2>

      <div id="vessels-panel">
        <div class="date-range-container">
          <div>
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" value="2023-08-01" />
          </div>
          <div>
            <label for="end-date">End Date:</label>
            <input type="date" id="end-date" value="2023-08-07" />
          </div>
        </div>
        
        <button id="load-btn">
          <i class="fas fa-sync-alt"></i> Load Vessel Data
        </button>
        
        <div class="filters-container">
          <div class="filter-title">
            <h3>Filter Vessels</h3>
            <span class="filter-badge" id="active-filters">0 active</span>
          </div>
          
          <div class="filter-row">
            <div>
              <label for="country-filter">Country:</label>
              <select id="country-filter">
                <option value="">All Countries</option>

              </select>
            </div>
          </div>
          
          <div class="filter-row">
            <div>
              <label for="type-filter">Ship Type:</label>
              <select id="type-filter">
                <option value="">All Types</option>

              </select>
            </div>
          </div>
          
          <div class="vessel-count">
            <div class="count-value" id="total-vessels">0</div>
            <div class="count-label">Total Vessels</div>
            <div class="count-value" id="filtered-vessels">0</div>
            <div class="count-label">Filtered Vessels</div>
            <div class="reset-filters" id="reset-filters">Reset Filters</div>
          </div>
        </div>
        
        <div class="search-container">
          <label for="vessel-search">Search Vessel:</label>
          <input type="text" id="vessel-search" placeholder="Type vessel name or MMSI..." />
          <span class="search-icon">üîç</span>
        </div>
        
        <div class="section-title">
          <h3>Vessels</h3>
          <span class="filter-badge" id="visible-vessels">0</span>
        </div>
        <div id="vessel-list" class="vessel-list"></div>
        
        <div class="chart-container">
          <div class="chart-title">
            <h3>Vessel Distribution</h3>
          </div>
          <div class="chart-wrapper">
            <canvas id="country-chart"></canvas>
          </div>
        </div>
        
        <div class="stats-panel">
          <h3>Vessel Statistics</h3>
          <div id="vessel-stats">
            <div class="stats-row">
              <span class="stats-label">Name:</span>
              <span class="stats-value" id="stats-name">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">MMSI:</span>
              <span class="stats-value" id="stats-mmsi">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Type:</span>
              <span class="stats-value" id="stats-type">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Callsign:</span>
              <span class="stats-value" id="stats-callsign">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Country:</span>
              <span class="stats-value" id="stats-country">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Duration:</span>
              <span class="stats-value" id="stats-duration">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Position Reports:</span>
              <span class="stats-value" id="stats-points">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Distance Traveled:</span>
              <span class="stats-value" id="stats-distance">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Avg. Speed:</span>
              <span class="stats-value" id="stats-speed">-</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Time Range:</span>
              <span class="stats-value" id="stats-time">-</span>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div id="map"></div>
    
    <div class="legend">
      <h3>Index</h3>
      <div class="legend-item">
        <div class="legend-color" style="background: #9c27b0;"></div>
        <span>Starting Point</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #4caf50;"></div>
        <span>Ending Point</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #00b4d8;"></div>
        <span>Position Points</span>
      </div>
    </div>
    
    <div class="loading-indicator" id="loading">
      <div class="loading-spinner"></div>
      <span>Loading vessel data...</span>
    </div>
    
    <div class="map-overlay">
      <h3>Vessel Trajectory</h3>
        </br>
      <p>This tool displays vessel movements using real AIS data.</p>
      <p>Select a vessel from the list to view its complete journey during the selected date range.</p>
      <p>Use filters to analyze specific vessel types and countries.</p>
    </div>
  </div>
  
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script>
    // Mapbox 
    mapboxgl.accessToken = 'pk.eyJ1IjoiZG9yamVlbGEiLCJhIjoiY20yZjV0ajVjMDVuNjJycHU5cmVoaWgzNSJ9.sKLqnfQLnaIrXYKpfht6aw';

    // Initialize map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/navigation-night-v1',
      center: [10, 30],
      zoom: 2,
      minZoom: 1,
      maxZoom: 15
    });
    
    // Store vessel data and layers
    let vesselData = {};
    let selectedVessel = null;
    let allVesselFeatures = [];
    let countryChart = null;

    // Elements
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const loadBtn = document.getElementById('load-btn');
    const vesselSearch = document.getElementById('vessel-search');
    const vesselList = document.getElementById('vessel-list');
    const loadingIndicator = document.getElementById('loading');
    const statsName = document.getElementById('stats-name');
    const statsMmsi = document.getElementById('stats-mmsi');
    const statsType = document.getElementById('stats-type');
    const statsCallsign = document.getElementById('stats-callsign');
    const statsPoints = document.getElementById('stats-points');
    const statsDistance = document.getElementById('stats-distance');
    const statsSpeed = document.getElementById('stats-speed');
    const statsTime = document.getElementById('stats-time');
    const statsCountry = document.getElementById('stats-country');
    const statsDuration = document.getElementById('stats-duration');
    const countryFilter = document.getElementById('country-filter');
    const typeFilter = document.getElementById('type-filter');
    const totalVessels = document.getElementById('total-vessels');
    const filteredVessels = document.getElementById('filtered-vessels');
    const visibleVessels = document.getElementById('visible-vessels');
    const activeFilters = document.getElementById('active-filters');
    const resetFilters = document.getElementById('reset-filters');
    const countryChartCtx = document.getElementById('country-chart').getContext('2d');

    // Date inputs
    const todayStr = new Date().toISOString().slice(0, 10);
    startDateInput.max = todayStr;
    endDateInput.max = todayStr;
    startDateInput.value = "2023-08-01";
    endDateInput.value = "2023-08-07";

    // Process vessel data from GeoJSON
    function processVesselData(geojson) {
      if (!geojson || !geojson.features) return;
      
      vesselData = {};
      const countries = new Set();
      const shipTypes = new Set();
      
      geojson.features.forEach(feature => {
        const properties = feature.properties;
        const mmsi = properties.mmsi;
        const vesselName = properties.name || `Vessel ${mmsi}`;
        const shipType = properties.shiptype || 'Unknown';
        const callsign = properties.callsign || 'N/A';
        const country = properties.country || 'Unknown';
        const duration = properties.duration || 'N/A';
        const distance = properties.distance ? parseFloat(properties.distance) : null;
        
        // Add to sets for filters
        countries.add(country);
        shipTypes.add(shipType);
        
        if (!vesselData[mmsi]) {
          vesselData[mmsi] = {
            name: vesselName,
            type: shipType,
            callsign: callsign,
            country: country,
            duration: duration,
            distance: distance,
            points: [],
            coordinates: [],
            timestamps: [],
            sog: []
          };
        }
        
        const coords = feature.geometry.coordinates;
        if (coords && coords.length === 2) {
          vesselData[mmsi].points.push({
            timestamp: properties.timestamp,
            coordinates: coords,
            sog: properties.sog || 0
          });
          vesselData[mmsi].coordinates.push(coords);
          vesselData[mmsi].timestamps.push(properties.timestamp);
          vesselData[mmsi].sog.push(properties.sog || 0);
        }
      });
      
      // Sort points by timestamp for each vessel
      Object.keys(vesselData).forEach(mmsi => {
        vesselData[mmsi].points.sort((a, b) => 
          new Date(a.timestamp) - new Date(b.timestamp)
        );
        
        // Update coordinates array to match sorted points
        vesselData[mmsi].coordinates = vesselData[mmsi].points.map(p => p.coordinates);
      });
      
      // Populate filter dropdowns
      populateFilters(Array.from(countries), Array.from(shipTypes));
      
      // Generate vessel list
      renderVesselList();
      
      // Update counts
      updateVesselCounts();
      
      // Create charts
      createCharts();
    }
    
    // Populate filter dropdowns
    function populateFilters(countries, shipTypes) {
      // Clear existing options
      countryFilter.innerHTML = '<option value="">All Countries</option>';
      typeFilter.innerHTML = '<option value="">All Types</option>';
      
      // Sort and add countries
      countries.sort();
      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
      });
      
      // Sort and add ship types
      shipTypes.sort();
      shipTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeFilter.appendChild(option);
      });
    }
    
    // Create charts
    function createCharts() {
      // Destroy existing chart if it exists
      if (countryChart) {
        countryChart.destroy();
      }
      
      // Count vessels by country
      const countryCounts = {};
      Object.values(vesselData).forEach(vessel => {
        countryCounts[vessel.country] = (countryCounts[vessel.country] || 0) + 1;
      });
      
      // Prepare chart data
      const chartData = {
        labels: Object.keys(countryCounts),
        datasets: [{
          data: Object.values(countryCounts),
          backgroundColor: [
            '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', 
            '#9966ff', '#ff9f40', '#8ac249', '#d45087',
            '#f95d6a', '#2f4b7c', '#665191', '#a05195'
          ],
          borderWidth: 0
        }]
      };
      
      // Create chart
      countryChart = new Chart(countryChartCtx, {
        type: 'doughnut',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#a8b2d1',
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed} vessels`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 2000
          }
        }
      });
    }
    
    // Update vessel counts
    function updateVesselCounts() {
      const total = Object.keys(vesselData).length;
      totalVessels.textContent = total;
      
      // Count filtered vessels
      const filteredCount = Object.values(vesselData).filter(vessel => {
        return matchesFilters(vessel);
      }).length;
      
      filteredVessels.textContent = filteredCount;
      
      // Update active filter count
      const activeFilterCount = (countryFilter.value ? 1 : 0) + (typeFilter.value ? 1 : 0);
      activeFilters.textContent = `${activeFilterCount} active`;
    }
    
    // Check if vessel matches filters
    function matchesFilters(vessel) {
      if (countryFilter.value && vessel.country !== countryFilter.value) return false;
      if (typeFilter.value && vessel.type !== typeFilter.value) return false;
      return true;
    }

    // Render vessel list with search and filters
    function renderVesselList() {
      vesselList.innerHTML = '';
      const searchTerm = vesselSearch.value.toLowerCase();
      let vesselCount = 0;
      
      Object.entries(vesselData).forEach(([mmsi, vessel]) => {
        // Apply filters
        if (!matchesFilters(vessel)) return;
        
        // Apply search
        if (!vessel.name.toLowerCase().includes(searchTerm)) return;
        
        vesselCount++;
        const vesselCard = document.createElement('div');
        vesselCard.className = 'vessel-card';
        if (selectedVessel === mmsi) {
          vesselCard.classList.add('selected');
        }
        
        vesselCard.innerHTML = `
          <div class="vessel-name">${vessel.name}</div>
          <div class="vessel-details">
            <div class="detail-label">MMSI:</div>
            <div>${mmsi}</div>
            <div class="detail-label">Type:</div>
            <div>${vessel.type}</div>
            <div class="detail-label">Country:</div>
            <div>${vessel.country}</div>
            <div class="detail-label">Points:</div>
            <div>${vessel.points.length}</div>
          </div>
        `;
        
        vesselCard.addEventListener('click', () => selectVessel(mmsi));
        vesselList.appendChild(vesselCard);
      });
      
      visibleVessels.textContent = vesselCount;
      
      if (vesselCount === 0) {
        vesselList.innerHTML = `<div style="text-align: center; padding: 20px; color: #8892b0;">
          No vessels found matching your filters
        </div>`;
      }
    }

    // Select a vessel to visualize
    function selectVessel(mmsi) {
      selectedVessel = mmsi;
      renderVesselList();
      visualizeVesselPath(mmsi);
      updateVesselStats(mmsi);
    }

    // Update vessel statistics
    function updateVesselStats(mmsi) {
      const vessel = vesselData[mmsi];
      if (!vessel) return;
      
      statsName.textContent = vessel.name;
      statsMmsi.textContent = mmsi;
      statsType.textContent = vessel.type;
      statsCallsign.textContent = vessel.callsign;
      statsCountry.textContent = vessel.country || 'Unknown';
      statsDuration.textContent = vessel.duration || 'N/A';
      statsPoints.textContent = vessel.points.length;
      statsDistance.textContent = vessel.distance ? `${vessel.distance.toFixed(2)} km` : 'N/A';
      
      // Calculate average speed
      if (vessel.sog.length > 0) {
        const totalSpeed = vessel.sog.reduce((sum, speed) => sum + speed, 0);
        const avgSpeed = totalSpeed / vessel.sog.length;
        statsSpeed.textContent = avgSpeed.toFixed(1) + ' knots';
      } else {
        statsSpeed.textContent = 'N/A';
      }
      
      // Show time range
      if (vessel.timestamps.length > 0) {
        const first = new Date(vessel.timestamps[0]);
        const last = new Date(vessel.timestamps[vessel.timestamps.length - 1]);
        statsTime.textContent = `${first.toLocaleDateString()} - ${last.toLocaleDateString()}`;
      } else {
        statsTime.textContent = 'N/A';
      }
    }

    // Visualize vessel path on the map
    function visualizeVesselPath(mmsi) {
      // Clear existing layers and sources
      const layersToRemove = [
        'vessel-path', 'start-point', 'end-point', 'vessel-points',
        'vessel-path-outline', 'vessel-points-highlight'
      ];
      
      layersToRemove.forEach(layer => {
        if (map.getLayer(layer)) map.removeLayer(layer);
      });
      
      const sourcesToRemove = [
        'vessel-path', 'start-point', 'end-point', 'vessel-points'
      ];
      
      sourcesToRemove.forEach(source => {
        if (map.getSource(source)) map.removeSource(source);
      });
      
      const vessel = vesselData[mmsi];
      if (!vessel || vessel.coordinates.length === 0) return;
      
      // Create line path for the vessel
      const pathData = {
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'LineString',
          coordinates: vessel.coordinates
        }
      };
      
      // Create start and end markers
      const startPoint = {
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'Point',
          coordinates: vessel.coordinates[0]
        }
      };
      
      const endPoint = {
        type: 'Feature',
        properties: {},
        geometry: {
          type: 'Point',
          coordinates: vessel.coordinates[vessel.coordinates.length - 1]
        }
      };
      
      // Create point collection for all positions
      const pointsData = {
        type: 'FeatureCollection',
        features: vessel.coordinates.map((coord, index) => ({
          type: 'Feature',
          properties: {
            timestamp: vessel.timestamps[index],
            sog: vessel.sog[index] || 0
          },
          geometry: {
            type: 'Point',
            coordinates: coord
          }
        }))
      };
      
      // Add the path to the map
      map.addSource('vessel-path', {
        type: 'geojson',
        data: pathData
      });
      /*
      // Add outline for better visibility
      map.addLayer({
        id: 'vessel-path-outline',
        type: 'line',
        source: 'vessel-path',
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#0a192f',
          'line-width': 5,
          'line-opacity': 0.8
        }
      });
      */
      
      // Add start point
      map.addSource('start-point', {
        type: 'geojson',
        data: startPoint
      });
      
      map.addLayer({
        id: 'start-point',
        type: 'circle',
        source: 'start-point',
        paint: {
          'circle-radius': 8,
          'circle-color': '#9c27b0',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add end point
      map.addSource('end-point', {
        type: 'geojson',
        data: endPoint
      });
      
      map.addLayer({
        id: 'end-point',
        type: 'circle',
        source: 'end-point',
        paint: {
          'circle-radius': 8,
          'circle-color': '#4caf50',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add all points
      map.addSource('vessel-points', {
        type: 'geojson',
        data: pointsData
      });
      
      // Base points
      map.addLayer({
        id: 'vessel-points',
        type: 'circle',
        source: 'vessel-points',
        paint: {
          'circle-radius': 3,
          'circle-color': '#00b4d8',
          'circle-opacity': 0.7
        }
      });
      
      // Highlight points
      map.addLayer({
        id: 'vessel-points-highlight',
        type: 'circle',
        source: 'vessel-points',
        paint: {
          'circle-radius': 4,
          'circle-color': '#ffffff',
          'circle-opacity': 0.9
        }
      });
      
      // Add popups to points
      map.on('click', 'vessel-points', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const timestamp = e.features[0].properties.timestamp;
        const sog = e.features[0].properties.sog;
        
        // Ensure the point is visible
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }
        
        new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(`
            <div style="font-weight: bold; margin-bottom: 5px;">Position Report</div>
            <div><strong>Time:</strong> ${timestamp}</div>
            <div><strong>Speed:</strong> ${sog} knots</div>
          `)
          .addTo(map);
      });
      
      // Change cursor on hover
      map.on('mouseenter', 'vessel-points', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'vessel-points', () => {
        map.getCanvas().style.cursor = '';
      });
      
      // Fly to the vessel path
      const bounds = new mapboxgl.LngLatBounds();
      vessel.coordinates.forEach(coord => bounds.extend(coord));
      
      // Add some padding to ensure all points are visible
      const padding = {
        top: 100,
        bottom: 100,
        left: 100,
        right: 100
      };
      
      map.fitBounds(bounds, {
        padding: padding,
        duration: 2000
      });
    }

    // Fetch GeoJSON from backend API
    async function loadVessels(startDate, endDate) {
      try {
        loadingIndicator.style.display = 'flex';
        const response = await fetch(`/api/vessels?start_date=${startDate}&end_date=${endDate}`);
        if (!response.ok) throw new Error('Failed to load vessel data');
        const data = await response.json();
        
        // Simulate delay to show loading indicator
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return data;
      } catch (err) {
        console.error('Error loading vessels:', err);
        alert('Error loading vessel data');
        return null;
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    // Handle load button click
    loadBtn.addEventListener('click', async () => {
      vesselData = {};
      selectedVessel = null;
      vesselList.innerHTML = '';
      
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      
      if (!startDate || !endDate) {
        alert('Please select start and end dates');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('End date must be after start date');
        return;
      }
      
      // Clear existing map layers
      const layersToRemove = [
        'vessel-path', 'start-point', 'end-point', 'vessel-points',
        'vessel-path-outline', 'vessel-points-highlight'
      ];
      
      layersToRemove.forEach(layer => {
        if (map.getLayer(layer)) map.removeLayer(layer);
      });
      
      const sourcesToRemove = [
        'vessel-path', 'start-point', 'end-point', 'vessel-points'
      ];
      
      sourcesToRemove.forEach(source => {
        if (map.getSource(source)) map.removeSource(source);
      });
      
      const geojson = await loadVessels(startDate, endDate);
      if (geojson) {
        processVesselData(geojson);
        
        // Auto-select the first vessel
        const firstVessel = Object.keys(vesselData)[0];
        if (firstVessel) {
          selectVessel(firstVessel);
        }
      }
    });

    // Handle vessel search
    vesselSearch.addEventListener('input', renderVesselList);
    
    // Handle filter changes
    countryFilter.addEventListener('change', function() {
      renderVesselList();
      updateVesselCounts();
    });
    
    typeFilter.addEventListener('change', function() {
      renderVesselList();
      updateVesselCounts();
    });
    
    // Handle reset filters
    resetFilters.addEventListener('click', function() {
      countryFilter.value = '';
      typeFilter.value = '';
      renderVesselList();
      updateVesselCounts();
    });
    
    // Initialize the map
    map.on('load', () => {
      map.addControl(new mapboxgl.NavigationControl());
      map.addControl(new mapboxgl.FullscreenControl());
      
      map.flyTo({
        center: [10, 30],
        zoom: 2,
        duration: 2000
      });
      
      // Load initial data
      setTimeout(() => {
        loadBtn.click();
      }, 1000);
    });
  </script>
</body>
</html>